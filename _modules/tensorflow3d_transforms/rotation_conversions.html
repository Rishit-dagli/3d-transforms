<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tensorflow3d_transforms.rotation_conversions &mdash; TensorFlow3d Transforms 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/dark_mode_css/general.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/dark_mode_css/dark.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="../../_static/dark_mode_js/default_light.js"></script>
        <script src="../../_static/dark_mode_js/theme_switcher.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> TensorFlow3d Transforms
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tensorflow3d_transforms.html">tensorflow3d_transforms package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TensorFlow3d Transforms</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tensorflow3d_transforms.rotation_conversions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tensorflow3d_transforms.rotation_conversions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module contains functions to convert between rotation representations.</span>

<span class="sd">The transformation matrices returned from the functions in this file</span>
<span class="sd">assume the points on which the transformation will be applied are column</span>
<span class="sd">vectors that is the R matrix is structured as</span>

<span class="sd">.. code-block:: python</span>
<span class="sd">    R = [</span>
<span class="sd">            [Rxx, Rxy, Rxz],</span>
<span class="sd">            [Ryx, Ryy, Ryz],</span>
<span class="sd">            [Rzx, Rzy, Rzz],</span>
<span class="sd">        ]  # (3, 3)</span>

<span class="sd">Furthermore, we will assume for any functions in this module that these are</span>
<span class="sd">quaternions with real part first that is a tensor of shape (..., 4).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>


<div class="viewcode-block" id="quaternion_to_matrix"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.quaternion_to_matrix">[docs]</a><span class="k">def</span> <span class="nf">quaternion_to_matrix</span><span class="p">(</span><span class="n">quaternions</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert rotations given as quaternions to rotation matrices.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        quaternion = tf.constant([0.0, 0.0, 0.0, 4.0])</span>
<span class="sd">        output = tensorflow3d_transforms.quaternion_to_matrix(quaternions=quaternion)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(3, 3), dtype=float32, numpy=</span>
<span class="sd">        # array([[-1.,  0.,  0.],</span>
<span class="sd">        #     [ 0., -1.,  0.],</span>
<span class="sd">        #     [ 0.,  0.,  1.]], dtype=float32)&gt;</span>


<span class="sd">    :param quaternions: A tensor of shape (..., 4) representing quaternions with real part first.</span>
<span class="sd">    :type quaternions: tf.Tensor</span>
<span class="sd">    :return: A tensor of shape (..., 3, 3) representing rotation matrices.</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">quaternions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">two_s</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">quaternions</span> <span class="o">*</span> <span class="n">quaternions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">o</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">k</span><span class="p">),</span>
            <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">j</span> <span class="o">-</span> <span class="n">k</span> <span class="o">*</span> <span class="n">r</span><span class="p">),</span>
            <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">r</span><span class="p">),</span>
            <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">r</span><span class="p">),</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">k</span><span class="p">),</span>
            <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">r</span><span class="p">),</span>
            <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">k</span> <span class="o">-</span> <span class="n">j</span> <span class="o">*</span> <span class="n">r</span><span class="p">),</span>
            <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">k</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">r</span><span class="p">),</span>
            <span class="mi">1</span> <span class="o">-</span> <span class="n">two_s</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="n">j</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">quaternions</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span></div>


<div class="viewcode-block" id="matrix_to_quaternion"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.matrix_to_quaternion">[docs]</a><span class="k">def</span> <span class="nf">matrix_to_quaternion</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert rotations given as rotation matrices to quaternions.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        matrix = tf.constant(</span>
<span class="sd">            [</span>
<span class="sd">                [</span>
<span class="sd">                    [0.15885946, -0.56794965, -0.48926896],</span>
<span class="sd">                    [-1.0064808, -0.39120296, 1.6047943],</span>
<span class="sd">                    [0.05503756, 0.817741, 0.4543775],</span>
<span class="sd">                ]</span>
<span class="sd">            ]</span>
<span class="sd">        )</span>

<span class="sd">        matrix_to_quaternion(matrix)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(1, 4), dtype=float32, numpy=</span>
<span class="sd">        # array([[-0.1688297 , -0.16717434,  0.9326495 ,  0.6493691 ]],</span>
<span class="sd">        # dtype=float32)&gt;</span>


<span class="sd">    :param matrix: A tensor of shape (..., 3, 3) representing rotation matrices.</span>
<span class="sd">    :type matrix: tf.Tensor</span>
<span class="sd">    :return: A tensor of shape (..., 4) representing quaternions with real part first.</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    :raises ValueError: If the shape of the input matrix is invalid that is does not have the shape (..., 3, 3).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid rotation matrix shape </span><span class="si">{matrix.shape}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">batch_dim</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">m00</span><span class="p">,</span> <span class="n">m01</span><span class="p">,</span> <span class="n">m02</span><span class="p">,</span> <span class="n">m10</span><span class="p">,</span> <span class="n">m11</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">m20</span><span class="p">,</span> <span class="n">m21</span><span class="p">,</span> <span class="n">m22</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">batch_dim</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span><span class="p">,)),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">q_abs</span> <span class="o">=</span> <span class="n">_sqrt_positive_part</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="mf">1.0</span> <span class="o">+</span> <span class="n">m00</span> <span class="o">+</span> <span class="n">m11</span> <span class="o">+</span> <span class="n">m22</span><span class="p">,</span>
                <span class="mf">1.0</span> <span class="o">+</span> <span class="n">m00</span> <span class="o">-</span> <span class="n">m11</span> <span class="o">-</span> <span class="n">m22</span><span class="p">,</span>
                <span class="mf">1.0</span> <span class="o">-</span> <span class="n">m00</span> <span class="o">+</span> <span class="n">m11</span> <span class="o">-</span> <span class="n">m22</span><span class="p">,</span>
                <span class="mf">1.0</span> <span class="o">-</span> <span class="n">m00</span> <span class="o">-</span> <span class="n">m11</span> <span class="o">+</span> <span class="n">m22</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">quat_by_rijk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">q_abs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">m21</span> <span class="o">-</span> <span class="n">m12</span><span class="p">,</span> <span class="n">m02</span> <span class="o">-</span> <span class="n">m20</span><span class="p">,</span> <span class="n">m10</span> <span class="o">-</span> <span class="n">m01</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">m21</span> <span class="o">-</span> <span class="n">m12</span><span class="p">,</span> <span class="n">q_abs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">m10</span> <span class="o">+</span> <span class="n">m01</span><span class="p">,</span> <span class="n">m02</span> <span class="o">+</span> <span class="n">m20</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">m02</span> <span class="o">-</span> <span class="n">m20</span><span class="p">,</span> <span class="n">m10</span> <span class="o">+</span> <span class="n">m01</span><span class="p">,</span> <span class="n">q_abs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">m12</span> <span class="o">+</span> <span class="n">m21</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">m10</span> <span class="o">-</span> <span class="n">m01</span><span class="p">,</span> <span class="n">m20</span> <span class="o">+</span> <span class="n">m02</span><span class="p">,</span> <span class="n">m21</span> <span class="o">+</span> <span class="n">m12</span><span class="p">,</span> <span class="n">q_abs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">flr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">quat_candidates</span> <span class="o">=</span> <span class="n">quat_by_rijk</span> <span class="o">/</span> <span class="p">(</span>
        <span class="mf">2.0</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">q_abs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">flr</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">max_indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">q_abs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">one_hot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">max_indices</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">quat_candidates</span><span class="p">,</span> <span class="n">one_hot</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">batch_dim</span> <span class="o">+</span> <span class="p">[</span><span class="mi">4</span><span class="p">])</span></div>


<span class="k">def</span> <span class="nf">_sqrt_positive_part</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns the square root of all positive elements of x and 0 for others.</span>

<span class="sd">    :param x: A tensor</span>
<span class="sd">    :type x: tf.Tensor</span>
<span class="sd">    :return: A tensor with the same shape as x</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">positive_mask</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">positive_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">_axis_angle_rotation</span><span class="p">(</span><span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">angle</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the rotation matrices for one of the rotations about an axis of</span>
<span class="sd">    which Euler angles describe, for each value of the angle given.</span>

<span class="sd">    :param axis: The axis about which the rotation is performed. Must be one of &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;.</span>
<span class="sd">    :type axis: str</span>
<span class="sd">    :param angle: Any shape tensor of Euler angles in radians</span>
<span class="sd">    :type angle: tf.Tensor</span>
<span class="sd">    :return: A tensor of shape (..., 3, 3) representing rotation matrices.</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    :raises ValueError: If the axis is not one of &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;letter must be either X, Y or Z.&quot;</span><span class="p">)</span>

    <span class="n">cos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">sin</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">one</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
        <span class="n">R_flat</span> <span class="o">=</span> <span class="p">(</span><span class="n">one</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="o">-</span><span class="n">sin</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
        <span class="n">R_flat</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="o">-</span><span class="n">sin</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span>
        <span class="n">R_flat</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="o">-</span><span class="n">sin</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">R_flat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">angle</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>


<div class="viewcode-block" id="euler_angles_to_matrix"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.euler_angles_to_matrix">[docs]</a><span class="k">def</span> <span class="nf">euler_angles_to_matrix</span><span class="p">(</span><span class="n">euler_angles</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">convention</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert rotations given as euler angles to rotation matrices.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        euler_angles = tf.constant(</span>
<span class="sd">            [</span>
<span class="sd">                [</span>
<span class="sd">                    [0.0, 0.0, 0.0],</span>
<span class="sd">                    [0.0, 0.0, 0.0],</span>
<span class="sd">                    [0.0, 0.0, 0.0],</span>
<span class="sd">                ]</span>
<span class="sd">            ]</span>
<span class="sd">        )</span>

<span class="sd">        euler_angles_to_matrix(euler_angles=euler_angles, convention=&quot;XYZ&quot;)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(1, 3, 3, 3), dtype=float32, numpy=</span>
<span class="sd">        # array([[[[1., 0., 0.],</span>
<span class="sd">        #          [0., 1., 0.],</span>
<span class="sd">        #          [0., 0., 1.]],</span>
<span class="sd">        #</span>
<span class="sd">        #         [[1., 0., 0.],</span>
<span class="sd">        #          [0., 1., 0.],</span>
<span class="sd">        #          [0., 0., 1.]],</span>
<span class="sd">        #</span>
<span class="sd">        #         [[1., 0., 0.],</span>
<span class="sd">        #          [0., 1., 0.],</span>
<span class="sd">        #          [0., 0., 1.]]]], dtype=float32)&gt;</span>

<span class="sd">    :param euler_angles: A tensor of shape (..., 3) representing euler angles.</span>
<span class="sd">    :type euler_angles: tf.Tensor</span>
<span class="sd">    :param convention: The euler angle convention. A string containing a combination of three uppercase letters from {&quot;X&quot;, &quot;Y&quot;, and &quot;Z&quot;}.</span>
<span class="sd">    :type convention: str</span>
<span class="sd">    :return: A tensor of shape (..., 3, 3) representing rotation matrices.</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    :raises ValueError: If the shape of the input euler angles is invalid that is does not have the shape (..., 3).</span>
<span class="sd">    :raises ValueError: If the convention string is invalid that is does not have the length 3.</span>
<span class="sd">    :raises ValueError: If the second character of the convention string is the same as the first or third.</span>
<span class="sd">    :raises ValueError: If the convention string contains characters other than {&quot;X&quot;, &quot;Y&quot;, and &quot;Z&quot;}.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">euler_angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid euler angle shape </span><span class="si">{euler_angles.shape}</span><span class="s2">, last dimension should&quot;</span>
            <span class="s2">&quot; be 3.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">convention</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid euler angle convention </span><span class="si">{convention}</span><span class="s2">, should be a string of&quot;</span>
            <span class="s2">&quot; length 3.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">convention</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">convention</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">convention</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid euler angle convention </span><span class="si">{convention}</span><span class="s2">, second character should be&quot;</span>
            <span class="s2">&quot; different from first and third.&quot;</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">convention</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">letter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid letter </span><span class="si">{letter}</span><span class="s2"> in convention string.&quot;</span><span class="p">)</span>

    <span class="n">matrices</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_axis_angle_rotation</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">convention</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">euler_angles</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">matrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">matrices</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">matrices</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>


<span class="k">def</span> <span class="nf">_index_from_letter</span><span class="p">(</span><span class="n">letter</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return the index of the axis corresponding to the letter.</span>

<span class="sd">    :param letter: The letter corresponding to the axis. Must be one of &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;.</span>
<span class="sd">    :type letter: str</span>
<span class="sd">    :return: The index of the axis.</span>
<span class="sd">    :rtype: int</span>
<span class="sd">    :raises ValueError: If the letter is not one of &#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">letter</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">letter</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">letter</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;letter must be either X, Y or Z.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_angle_from_tan</span><span class="p">(</span>
    <span class="n">axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">other_axis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">horizontal</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">tait_bryan</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Extract the first or third Euler angle from the two members of the</span>
<span class="sd">    matrix which are positive constant times its sine and cosine.</span>

<span class="sd">    :param axis: Axis label &quot;X&quot; or &quot;Y or &quot;Z&quot; for the angle we are finding.</span>
<span class="sd">    :type axis: str</span>
<span class="sd">    :param other_axis: Axis label &quot;X&quot; or &quot;Y or &quot;Z&quot; for the middle axis in the convention.</span>
<span class="sd">    :type other_axis: str</span>
<span class="sd">    :param data: Rotation matrices as tensor of shape (..., 3, 3).</span>
<span class="sd">    :type data: tf.Tensor</span>
<span class="sd">    :param horizontal: Whether we are looking for the angle for the third axis, which means the relevant entries are in the same row of the rotation matrix. If not, they are in the same column.</span>
<span class="sd">    :type horizontal: bool</span>
<span class="sd">    :param tait_bryan: Whether the first and third axes in the convention differ.</span>
<span class="sd">    :type tait_bryan: bool</span>
<span class="sd">    :return: Euler Angles in radians for each matrix in data as a tensor of shape (...).</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}[</span><span class="n">axis</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">horizontal</span><span class="p">:</span>
        <span class="n">i2</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span>
    <span class="n">even</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis</span> <span class="o">+</span> <span class="n">other_axis</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;XY&quot;</span><span class="p">,</span> <span class="s2">&quot;YZ&quot;</span><span class="p">,</span> <span class="s2">&quot;ZX&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">horizontal</span> <span class="o">==</span> <span class="n">even</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">tait_bryan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i2</span><span class="p">],</span> <span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i1</span><span class="p">])</span>


<div class="viewcode-block" id="matrix_to_euler_angles"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.matrix_to_euler_angles">[docs]</a><span class="k">def</span> <span class="nf">matrix_to_euler_angles</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">convention</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert rotation matrices to euler angles in radians.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        matrix = tf.constant(</span>
<span class="sd">            [</span>
<span class="sd">                [</span>
<span class="sd">                    [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]],</span>
<span class="sd">                    [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]],</span>
<span class="sd">                    [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]],</span>
<span class="sd">                ]</span>
<span class="sd">            ]</span>
<span class="sd">        )</span>
<span class="sd">        matrix_to_euler_angles(matrix=matrix, convention=&quot;XYZ&quot;)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(1, 3, 3), dtype=float32, numpy=</span>
<span class="sd">        # array([[[-0.,  0., -0.],</span>
<span class="sd">        #         [-0.,  0., -0.],</span>
<span class="sd">        #         [-0.,  0., -0.]]], dtype=float32)&gt;</span>

<span class="sd">    :param matrix: A tensor of shape (..., 3, 3) representing rotation matrices.</span>
<span class="sd">    :type matrix: tf.Tensor</span>
<span class="sd">    :param convention: The euler angle convention. A string containing a combination of three uppercase letters from {&quot;X&quot;, &quot;Y&quot;, and &quot;Z&quot;}.</span>
<span class="sd">    :type convention: str</span>
<span class="sd">    :return: A tensor of shape (..., 3) representing euler angles.</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    :raises ValueError: If the shape of the input matrix is invalid that is does not have the shape (..., 3, 3).</span>
<span class="sd">    :raises ValueError: If the convention string is invalid that is does not have the length 3.</span>
<span class="sd">    :raises ValueError: If the second character of the convention string is the same as the first or third.</span>
<span class="sd">    :raises ValueError: If the convention string contains characters other than {&quot;X&quot;, &quot;Y&quot;, and &quot;Z&quot;}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">convention</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid euler angle convention </span><span class="si">{convention}</span><span class="s2">, should be a string of&quot;</span>
            <span class="s2">&quot; length 3.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">convention</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">convention</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">convention</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid euler angle convention </span><span class="si">{convention}</span><span class="s2">, second character should be&quot;</span>
            <span class="s2">&quot; different from first and third.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid matrix shape </span><span class="si">{matrix.shape}</span><span class="s2">, last two dimensions should be 3, 3.&quot;</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">convention</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">letter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid letter </span><span class="si">{letter}</span><span class="s2"> in convention string.&quot;</span><span class="p">)</span>

    <span class="n">i0</span> <span class="o">=</span> <span class="n">_index_from_letter</span><span class="p">(</span><span class="n">convention</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">_index_from_letter</span><span class="p">(</span><span class="n">convention</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">tait_bryan</span> <span class="o">=</span> <span class="n">i0</span> <span class="o">!=</span> <span class="n">i2</span>

    <span class="k">if</span> <span class="n">tait_bryan</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i0</span> <span class="o">-</span> <span class="n">i2</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">central_angle</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">central_angle</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">central_angle</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i0</span><span class="p">])</span>

    <span class="n">o</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_angle_from_tan</span><span class="p">(</span>
            <span class="n">convention</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">convention</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i2</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="n">tait_bryan</span>
        <span class="p">),</span>
        <span class="n">central_angle</span><span class="p">,</span>
        <span class="n">_angle_from_tan</span><span class="p">(</span>
            <span class="n">convention</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">convention</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">True</span><span class="p">,</span> <span class="n">tait_bryan</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_copysign</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return a tensor where each element has the absolute value taken from</span>
<span class="sd">    the, corresponding element of a, with sign taken from the corresponding</span>
<span class="sd">    element of b. This is like the standard copysign floating-point operation,</span>
<span class="sd">    but is not careful about negative 0 and NaN.</span>

<span class="sd">    :param a: Source tensor.</span>
<span class="sd">    :type a: tf.Tensor</span>
<span class="sd">    :param b: Tensor whose signs will be used, of the same shape as a.</span>
<span class="sd">    :type b: tf.Tensor</span>
<span class="sd">    :return: Tensor of the same shape as a with the signs of b.</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    :raises ValueError: If the shapes of a and b do not match.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shapes of a and b do not match: </span><span class="si">{a.shape}</span><span class="s2"> and </span><span class="si">{b.shape}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">signs_differ</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">signs_differ</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>


<div class="viewcode-block" id="random_quaternions"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.random_quaternions">[docs]</a><span class="k">def</span> <span class="nf">random_quaternions</span><span class="p">(</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate random quaternions representing rotations, i.e. versors with</span>
<span class="sd">    nonnegative real part.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        random_quaternions(2)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(2, 4), dtype=float32, numpy=...&gt;</span>

<span class="sd">    :param n: Number of quaternions to generate.</span>
<span class="sd">    :type n: int</span>
<span class="sd">    :param dtype: Data type of the returned tensor, defaults to tf.float32.</span>
<span class="sd">    :type dtype: Optional[tf.dtype], optional</span>
<span class="sd">    :return: Tensor of shape (n, 4) representing quaternions.</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">o</span> <span class="o">*</span> <span class="n">o</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">o</span> <span class="o">/</span> <span class="n">_copysign</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">o</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">o</span></div>


<div class="viewcode-block" id="random_rotations"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.random_rotations">[docs]</a><span class="k">def</span> <span class="nf">random_rotations</span><span class="p">(</span>
    <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DType</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate random rotations as 3x3 rotation matrices.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        random_rotations(2)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(2, 3, 3), dtype=float32, numpy=...&gt;</span>

<span class="sd">    :param n: Number of rotation matrices to generate.</span>
<span class="sd">    :type n: int</span>
<span class="sd">    :param dtype: Data type of the returned tensor, defaults to tf.float32.</span>
<span class="sd">    :type dtype: Optional[tf.dtype], optional</span>
<span class="sd">    :return: Tensor of shape (n, 3, 3) representing rotation matrices.</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">quaternions</span> <span class="o">=</span> <span class="n">random_quaternions</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quaternion_to_matrix</span><span class="p">(</span><span class="n">quaternions</span><span class="p">)</span></div>


<div class="viewcode-block" id="standardize_quaternion"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.standardize_quaternion">[docs]</a><span class="k">def</span> <span class="nf">standardize_quaternion</span><span class="p">(</span><span class="n">quaternions</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert a unit quaternion to a standard form: one in which the real part</span>
<span class="sd">    is non negative.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        quaternions = tf.constant((-1.,-2.,-1.,-1.))</span>
<span class="sd">        standardize_quaternion(quaternions=quaternions)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([ 1.,  2.,  1.,  1.], dtype=float32)&gt;</span>

<span class="sd">    :param quaternions: Quaternions with real part first, as tensor of shape (..., 4).</span>
<span class="sd">    :type quaternions: tf.Tensor</span>
<span class="sd">    :return: Standardized quaternions as tensor of shape (..., 4).</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">quaternions</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">quaternions</span><span class="p">,</span> <span class="n">quaternions</span><span class="p">)</span></div>


<div class="viewcode-block" id="quaternion_raw_multiply"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.quaternion_raw_multiply">[docs]</a><span class="k">def</span> <span class="nf">quaternion_raw_multiply</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Multiply two quaternions.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        a = tf.constant((1.,2.,3.,4.))</span>
<span class="sd">        b = tf.constant((5.,6.,7.,8.))</span>
<span class="sd">        quaternion_raw_multiply(a=a, b=b)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([-60.,  12.,  30.,  24.], dtype=float32)&gt;</span>

<span class="sd">    :param a: First quaternion with real part first, as tensor of shape (..., 4).</span>
<span class="sd">    :type a: tf.Tensor</span>
<span class="sd">    :param b: Second quaternion with real part first, as tensor of shape (..., 4).</span>
<span class="sd">    :type b: tf.Tensor</span>
<span class="sd">    :return: Product of a and b as tensor of shape (..., 4).</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aw</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">az</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bw</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">bz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ow</span> <span class="o">=</span> <span class="n">aw</span> <span class="o">*</span> <span class="n">bw</span> <span class="o">-</span> <span class="n">ax</span> <span class="o">*</span> <span class="n">bx</span> <span class="o">-</span> <span class="n">ay</span> <span class="o">*</span> <span class="n">by</span> <span class="o">-</span> <span class="n">az</span> <span class="o">*</span> <span class="n">bz</span>
    <span class="n">ox</span> <span class="o">=</span> <span class="n">aw</span> <span class="o">*</span> <span class="n">bx</span> <span class="o">+</span> <span class="n">ax</span> <span class="o">*</span> <span class="n">bw</span> <span class="o">+</span> <span class="n">ay</span> <span class="o">*</span> <span class="n">bz</span> <span class="o">-</span> <span class="n">az</span> <span class="o">*</span> <span class="n">by</span>
    <span class="n">oy</span> <span class="o">=</span> <span class="n">aw</span> <span class="o">*</span> <span class="n">by</span> <span class="o">-</span> <span class="n">ax</span> <span class="o">*</span> <span class="n">bz</span> <span class="o">+</span> <span class="n">ay</span> <span class="o">*</span> <span class="n">bw</span> <span class="o">+</span> <span class="n">az</span> <span class="o">*</span> <span class="n">bx</span>
    <span class="n">oz</span> <span class="o">=</span> <span class="n">aw</span> <span class="o">*</span> <span class="n">bz</span> <span class="o">+</span> <span class="n">ax</span> <span class="o">*</span> <span class="n">by</span> <span class="o">-</span> <span class="n">ay</span> <span class="o">*</span> <span class="n">bx</span> <span class="o">+</span> <span class="n">az</span> <span class="o">*</span> <span class="n">bw</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ow</span><span class="p">,</span> <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">,</span> <span class="n">oz</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="quaternion_multiply"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.quaternion_multiply">[docs]</a><span class="k">def</span> <span class="nf">quaternion_multiply</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Multiply two quaternions representing rotations, returning the</span>
<span class="sd">    quaternion representing their composition, i.e. the versor with nonnegative</span>
<span class="sd">    real part.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        a = tf.constant((1.,2.,3.,4.))</span>
<span class="sd">        b = tf.constant((5.,6.,7.,8.))</span>
<span class="sd">        quaternion_multiply(a=a, b=b)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([ 60., -12., -30., -24.], dtype=float32)&gt;</span>

<span class="sd">    :param a: First quaternion with real part first, as tensor of shape (..., 4).</span>
<span class="sd">    :type a: tf.Tensor</span>
<span class="sd">    :param b: Second quaternion with real part first, as tensor of shape (..., 4).</span>
<span class="sd">    :type b: tf.Tensor</span>
<span class="sd">    :return: Product of a and b as tensor of shape (..., 4).</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">standardize_quaternion</span><span class="p">(</span><span class="n">quaternion_raw_multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span></div>


<div class="viewcode-block" id="quaternion_invert"><a class="viewcode-back" href="../../tensorflow3d_transforms.html#tensorflow3d_transforms.rotation_conversions.quaternion_invert">[docs]</a><span class="k">def</span> <span class="nf">quaternion_invert</span><span class="p">(</span><span class="n">quaternion</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Given a quaternion representing rotation, get the quaternion</span>
<span class="sd">    representing its inverse.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        quaternion = tf.constant((1.,2.,3.,4.))</span>
<span class="sd">        quaternion_invert(quaternion=quaternion)</span>
<span class="sd">        # &lt;tf.Tensor: shape=(4,), dtype=float32, numpy=array([ 1., -2., -3., -4.], dtype=float32)&gt;</span>

<span class="sd">    :param quaternion: Quaternions as tensor of shape (..., 4), with real part first, which must be versors (unit quaternions).</span>
<span class="sd">    :type quaternion: tf.Tensor</span>
<span class="sd">    :return: The inverse, a tensor of quaternions of shape (..., 4).</span>
<span class="sd">    :rtype: tf.Tensor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scaling</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">quaternion</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quaternion</span> <span class="o">*</span> <span class="n">scaling</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Rishit Dagli.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>